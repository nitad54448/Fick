<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ThermoMigrate v3.4 (Days Timeline)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    
    <!-- MathJax for Physics Formulas -->
    <script>
    window.MathJax = {
      tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] }
    };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        .tab-btn { color: #64748b; padding: 0 1rem; transition: all 0.2s; font-weight: 600; font-size: 0.8rem; border-bottom: 2px solid transparent; white-space: nowrap; }
        .tab-btn:hover { color: #1e293b; background-color: #f8fafc; }
        .tab-btn.active { background-color: #f0fdf4; color: #15803d; border-bottom-color: #15803d; }
        
        /* Updated Tab Pane Logic */
        .tab-pane { display: none; width: 100%; animation: fadeIn 0.3s ease-out; }
        .tab-pane.active { display: flex; flex-direction: column; gap: 1rem; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .plot-container-2d { min-height: 300px; position: relative; }
        .plot-container-3d { min-height: 500px; border: 1px solid #e2e8f0; border-radius: 0.5rem; background: white; padding: 10px; }
        
        /* Prose overrides for compact theory section */
        .prose h2 { margin-top: 1.5em; margin-bottom: 0.5em; }
        .prose h3 { margin-top: 1.2em; margin-bottom: 0.5em; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-800 bg-slate-50 font-sans">

    <!-- Header -->
    <div class="bg-white border-b border-gray-200 px-4 flex items-center justify-between shrink-0 h-14 shadow-sm z-20">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-indigo-600 rounded flex items-center justify-center text-white font-bold shadow-md">
                <i class="fas fa-atom"></i>
            </div>
            <div>
                <h1 class="font-bold text-lg text-slate-800 leading-tight">ThermoMigrate <span class="text-xs font-normal text-slate-500 ml-1">v3.4</span></h1>
                <p class="text-[10px] text-slate-400 font-mono leading-none">PbSe Thermocouple Evolution</p>
            </div>
        </div>
        
        <div id="status-area" class="flex-1 mx-8 flex items-center gap-3 opacity-0 transition-opacity duration-300">
            <div class="h-1.5 flex-1 bg-gray-100 rounded-full overflow-hidden">
                <div id="header-progress" class="h-full bg-indigo-500 w-0 transition-all duration-200"></div>
            </div>
            <span id="header-status" class="text-xs font-mono text-gray-400 w-24 text-right">Processing...</span>
        </div>

        <div class="flex space-x-1 h-full overflow-x-auto mx-4 no-scrollbar">
            <button onclick="switchTab('conc')" id="tab-conc" class="tab-btn active h-full flex items-center">
                <i class="fas fa-chart-area mr-2"></i> Conc (C)
            </button>
            <button onclick="switchTab('zt')" id="tab-zt" class="tab-btn h-full flex items-center">
                <i class="fas fa-bolt mr-2"></i> ZT
            </button>
            <button onclick="switchTab('seebeck')" id="tab-seebeck" class="tab-btn h-full flex items-center">
                <i class="fas fa-wave-square mr-2"></i> Seebeck (S)
            </button>
            <button onclick="switchTab('sigma')" id="tab-sigma" class="tab-btn h-full flex items-center">
                <i class="fas fa-bolt mr-2"></i> Sigma (σ)
            </button>
            <button onclick="switchTab('theory')" id="tab-theory" class="tab-btn h-full flex items-center text-blue-600">
                <i class="fas fa-book mr-2"></i> Theory
            </button>
        </div>
    </div>

    <div class="flex flex-1 overflow-hidden relative">
        
        <!-- Sidebar Controls -->
        <aside class="w-full md:w-80 bg-white border-r border-gray-200 flex flex-col h-full z-10 shadow-[4px_0_24px_rgba(0,0,0,0.02)] shrink-0 overflow-y-auto">
                           
            <div class="p-4 space-y-5">
                
                <!-- 1. Geometry & Thermal -->
                <div class="bg-red-50 p-4 rounded-lg border border-red-100 shadow-sm relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-red-500 to-blue-500"></div>
                    <div class="flex items-center gap-2 mb-3">
                        <i class="fas fa-thermometer-half text-red-600"></i>
                        <h3 class="text-xs font-bold text-red-800 uppercase tracking-wider">1. Thermal Gradient</h3>
                    </div>
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div class="input-group">
                            <label class="text-[10px] text-red-700 font-bold block mb-1">T_Hot (Left) [K]</label>
                            <input type="number" id="tHot" value="700" min="300" max="1500" class="w-full text-sm border border-red-200 rounded p-1.5 font-bold text-red-700 bg-white focus:ring-2 focus:ring-red-200 outline-none" onchange="debouncedUpdate()">
                        </div>
                        <div class="input-group">
                            <label class="text-[10px] text-blue-700 font-bold block mb-1">T_Cold (Right) [K]</label>
                            <input type="number" id="tCold" value="600" min="200" max="1000" class="w-full text-sm border border-blue-200 rounded p-1.5 font-bold text-blue-700 bg-white focus:ring-2 focus:ring-blue-200 outline-none" onchange="debouncedUpdate()">
                        </div>
                    </div>
                    <div class="input-group">
                        <label class="text-[10px] text-slate-600 font-bold block mb-1">Leg Length (mm)</label>
                        <div class="relative">
                            <input type="number" id="legLength" value="5" min="1" step="0.5" class="w-full text-sm border border-slate-300 rounded p-1.5 font-semibold" onchange="debouncedUpdate()">
                            <span class="absolute right-2 top-1.5 text-xs text-slate-400">mm</span>
                        </div>
                    </div>
                </div>

                <!-- 2. Timeline -->


                <div class="bg-slate-50 p-3 rounded border border-slate-200">
                    <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">2. Timeline</h3>
                    <div class="input-group">
                        <label class="text-[10px] text-gray-500 font-bold block">Duration (Days)</label>
                        <input type="number" id="timeValue" value="30" min="0.01" max="365" step="0.01" class="w-full text-sm border border-gray-300 rounded p-1" onchange="debouncedUpdate()">
                    </div>
                </div>

                <div class="bg-emerald-50 p-3 rounded border border-emerald-100 space-y-3">
                    
                    <div class="flex justify-between items-center">
                        <h3 class="text-xs font-bold text-emerald-800 uppercase tracking-wider">3. Dopant (PbSe)</h3>
                        <select id="presetSelect" class="text-[10px] bg-white border border-emerald-200 rounded px-2 py-1 text-emerald-700 font-bold cursor-pointer hover:bg-emerald-100" onchange="loadPreset()">
                            <option value="custom">Custom Params</option>
                            <option value="Na" selected>Na (p-type)</option>
                            <option value="Ag">Ag (Fast)</option>
                            <option value="Cl">Cl (n-type)</option>
                        </select>
                    </div>

                    <div>
                        <label class="text-[10px] text-emerald-700 font-bold block mb-1">Concentration ($C(x)$) [cm⁻³]</label>
                        
                        <input type="text" id="c0" value="1e19" 
                            class="w-full text-xs font-mono border border-emerald-200 rounded p-1.5 bg-white placeholder-emerald-200 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none transition-colors" 
                            placeholder="e.g. 1e19 or 1e19 * (1-x)" 
                            onchange="debouncedUpdate()"
                            oninput="clearError()"> 
                        
                        <div id="conc-error" style="display:none;" class="mt-2 p-2 bg-red-50 border border-red-200 rounded text-[10px] text-red-600 font-bold leading-tight">
                            <i class="fas fa-exclamation-circle mr-1"></i> <span id="conc-error-text">Error</span>
                        </div>

                        <p class="text-[9px] text-slate-500 mt-1 italic leading-tight">
                            Type a number (e.g. <code>1e19</code>) or a function of <code>x</code>, x=0 is hot side, x=1 cold side.                            Ex: <code>2e19 * (1 - 0.5*x)</code>
                        </p>
                    </div>

                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-[10px] text-emerald-700 font-bold block">D₀ (m²/s)</label>
                            <input type="text" id="d0" value="2.3e-7" class="w-full text-xs border border-emerald-200 rounded p-1" onchange="debouncedUpdate()">
                        </div>
                        <div>
                            <label class="text-[10px] text-emerald-700 font-bold block">Ea (eV)</label>
                            <input type="number" id="ea" value="0.6" step="0.05" class="w-full text-xs border border-emerald-200 rounded p-1" onchange="debouncedUpdate()">
                        </div>
                    </div>

                    <div class="pt-2 border-t border-emerald-200">
                        <div class="flex items-center justify-between mb-1">
                            <label class="text-[10px] text-purple-700 font-bold">Heat of Transport Q* (eV)</label>
                        </div>
                        <input type="number" id="qStar" value="0.2" step="0.05" class="w-full text-xs border border-purple-200 rounded p-1 font-bold text-purple-800 bg-purple-50" onchange="debouncedUpdate()">
                    </div>

                </div>

                <div class="mt-auto pt-4">
                    <button onclick="downloadData()" class="w-full text-xs bg-slate-800 hover:bg-slate-700 text-white font-bold py-3 rounded shadow-md transition-all">
                        <i class="fas fa-file-csv mr-2"></i> Export Data
                    </button>
                </div>


            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-1 flex flex-col h-full relative bg-slate-100 overflow-y-auto overflow-x-hidden p-6">
            
            <!-- PANEL 1: CONCENTRATION -->
            <div id="pane-conc" class="tab-pane active">
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 flex flex-col">
                    <h2 class="text-sm font-bold text-slate-700 uppercase mb-4 flex justify-between">
                        <span><i class="fas fa-chart-line mr-2 text-indigo-500"></i> Final Concentration Profile (2D)</span>
                        <span class="text-xs bg-gray-100 px-2 py-1 rounded text-gray-500">t = Final</span>
                    </h2>
                    <div class="plot-container-2d relative">
                        <canvas id="chartConc"></canvas>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 flex flex-col">
                    <h2 class="text-sm font-bold text-slate-700 uppercase mb-4">
                        <i class="fas fa-cube mr-2 text-indigo-500"></i> Concentration Evolution (3D)
                    </h2>
                    <div id="plotlyConc" class="plot-container-3d"></div>
                </div>
            </div>

            <!-- PANEL 2: ZT -->
            <div id="pane-zt" class="tab-pane">
                 <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 flex flex-col">
                    <h2 class="text-sm font-bold text-slate-700 uppercase mb-4 flex justify-between">
                        <span><i class="fas fa-bolt mr-2 text-amber-500"></i> Final Figure of Merit zT (2D)</span>
                        <span id="avg-zt-display" class="text-xs bg-amber-100 text-amber-800 px-2 py-1 rounded font-mono">Avg ZT: -</span>
                    </h2>
                    <div class="plot-container-2d relative">
                        <canvas id="chartZT"></canvas>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 flex flex-col">
                    <h2 class="text-sm font-bold text-slate-700 uppercase mb-4">
                        <i class="fas fa-layer-group mr-2 text-amber-500"></i> ZT Evolution (3D)
                    </h2>
                    <div id="plotlyZT" class="plot-container-3d"></div>
                </div>
            </div>

            <!-- PANEL 3: SEEBECK -->
            <div id="pane-seebeck" class="tab-pane">
                 <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 flex flex-col">
                    <h2 class="text-sm font-bold text-slate-700 uppercase mb-4">
                        <i class="fas fa-wave-square mr-2 text-purple-500"></i> Final Seebeck Coefficient (2D)
                    </h2>
                    <div class="plot-container-2d relative">
                        <canvas id="chartS"></canvas>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 flex flex-col">
                    <h2 class="text-sm font-bold text-slate-700 uppercase mb-4">
                        <i class="fas fa-layer-group mr-2 text-purple-500"></i> Seebeck Evolution (3D)
                    </h2>
                    <div id="plotlyS" class="plot-container-3d"></div>
                </div>
            </div>

            <!-- PANEL 4: CONDUCTIVITY -->
            <div id="pane-sigma" class="tab-pane">
                 <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 flex flex-col">
                    <h2 class="text-sm font-bold text-slate-700 uppercase mb-4">
                        <i class="fas fa-bolt mr-2 text-blue-500"></i> Final Conductivity (2D)
                    </h2>
                    <div class="plot-container-2d relative">
                        <canvas id="chartSigma"></canvas>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 flex flex-col">
                    <h2 class="text-sm font-bold text-slate-700 uppercase mb-4">
                        <i class="fas fa-layer-group mr-2 text-blue-500"></i> Conductivity Evolution (3D)
                    </h2>
                    <div id="plotlySigma" class="plot-container-3d"></div>
                </div>
            </div>


            <div id="pane-theory" class="tab-pane bg-white p-8 rounded-lg shadow-sm border border-gray-200 overflow-y-auto">
                <div class="max-w-4xl mx-auto pb-20 prose prose-slate">
                    
                    <div class="flex items-center gap-3 mb-6 border-b border-gray-200 pb-4">
                        <div class="bg-indigo-600 text-white w-10 h-10 rounded flex items-center justify-center font-bold text-xl">
                            <i class="fas fa-book"></i>
                        </div>
                        <div>
                            <h1 class="text-3xl font-bold text-slate-800 m-0">User Guide</h1>
                            <p class="text-slate-500 m-0 text-sm">ThermoMigrate v3.4 Documentation</p>
                        </div>
                    </div>

                    <div class="bg-emerald-50 border border-emerald-200 rounded-lg p-6 mb-8">
                        <h2 class="text-xl font-bold text-emerald-900 mt-0 mb-4">
                            <i class="fas fa-calculator mr-2"></i> How to use "Smart Input"
                        </h2>
                        <p class="text-sm text-emerald-800 mb-4">
                            The <strong>Concentration</strong> field accepts JavaScript math expressions. You can define complex initial gradients to test Functionally Graded Materials (FGM).
                        </p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-white p-4 rounded border border-emerald-100 shadow-sm">
                                <h4 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">The Variable 'x'</h4>
                                <ul class="text-sm space-y-2 m-0 pl-0 list-none">
                                    <li class="flex items-center justify-between border-b border-gray-100 pb-1">
                                        <span><code class="font-bold text-red-600">x = 0.0</code></span>
                                        <span class="text-gray-500">Hot Side (Left)</span>
                                    </li>
                                    <li class="flex items-center justify-between">
                                        <span><code class="font-bold text-blue-600">x = 1.0</code></span>
                                        <span class="text-gray-500">Cold Side (Right)</span>
                                    </li>
                                </ul>
                                <p class="text-xs text-slate-400 mt-2 italic">The profile is normalized to leg length.</p>
                            </div>

                            <div class="bg-white p-4 rounded border border-emerald-100 shadow-sm">
                                <h4 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Supported Math</h4>
                                <div class="text-xs text-slate-600 font-mono grid grid-cols-3 gap-2">
                                    <span class="bg-gray-50 p-1 rounded">exp(x)</span>
                                    <span class="bg-gray-50 p-1 rounded">log(x)</span>
                                    <span class="bg-gray-50 p-1 rounded">pow(a,b)</span>
                                    <span class="bg-gray-50 p-1 rounded">sin(x)</span>
                                    <span class="bg-gray-50 p-1 rounded">cos(x)</span>
                                    <span class="bg-gray-50 p-1 rounded">sqrt(x)</span>
                                </div>
                                <p class="text-xs text-slate-400 mt-2 italic">Standard JS operators (+, -, *, /) apply.</p>
                            </div>
                        </div>
                    </div>

                    <h2 class="text-2xl font-bold text-slate-800 mt-8 mb-4">Exemple Profile Equations</h2>
                    <p>Copy and paste these directly into the Concentration input field to test different scenarios.</p>

                    <div class="overflow-hidden border border-gray-200 rounded-lg shadow-sm mb-8">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-100 text-slate-700 font-bold uppercase text-xs">
                                <tr>
                                    <th class="px-4 py-3">Profile Type</th>
                                    <th class="px-4 py-3">Equation Example</th>
                                    <th class="px-4 py-3">Why test this?</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200 bg-white">
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-3 font-bold text-slate-700">Constant (Flat)</td>
                                    <td class="px-4 py-3"><code class="bg-slate-100 px-2 py-1 rounded text-pink-600 select-all">1e19</code></td>
                                    <td class="px-4 py-3 text-slate-500">The standard baseline.</td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-3 font-bold text-slate-700">Linear Grading</td>
                                    <td class="px-4 py-3">
                                        <code class="bg-slate-100 px-2 py-1 rounded text-pink-600 select-all block mb-1">2e19 * (1 - 0.5*x)</code>
                                        <span class="text-[10px] text-gray-400">Starts at 2e19, drops to 1e19</span>
                                    </td>
                                    <td class="px-4 py-3 text-slate-500">Optimizes $zT$ by matching carrier conc to temperature ($n \propto T^{1.5}$).</td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-3 font-bold text-slate-700">Exponential</td>
                                    <td class="px-4 py-3"><code class="bg-slate-100 px-2 py-1 rounded text-pink-600 select-all">1e19 * exp(2*x)</code></td>
                                    <td class="px-4 py-3 text-slate-500">Rapidly increasing dopant towards the cold side.</td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-3 font-bold text-slate-700">Step Function</td>
                                    <td class="px-4 py-3">
                                        <code class="bg-slate-100 px-2 py-1 rounded text-pink-600 select-all">x < 0.5 ? 2e19 : 1e18</code>
                                    </td>
                                    <td class="px-4 py-3 text-slate-500">Simulates a diffusion couple (High conc joined to Low conc).</td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-3 font-bold text-slate-700">Parabolic</td>
                                    <td class="px-4 py-3"><code class="bg-slate-100 px-2 py-1 rounded text-pink-600 select-all">1e19 * (1 + 4*x*(1-x))</code></td>
                                    <td class="px-4 py-3 text-slate-500">Peak concentration in the middle of the leg.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <h2 class="text-2xl font-bold text-slate-800 mt-12 mb-4">3. Underlying Physics (v2 Model)</h2>
                    
                    <h3 class="text-lg font-bold text-slate-700 mt-6 mb-2">A. The Soret Effect</h3>
                    <p>Dopants migrate due to the temperature gradient. The direction is determined by the <strong>Heat of Transport ($Q^*$)</strong>.</p>
                    <div class="bg-amber-50 border-l-4 border-amber-400 p-4 my-4">
                        <ul class="list-none pl-0 m-0 space-y-2 text-sm text-amber-900">
                            <li><i class="fas fa-arrow-right text-amber-600 w-6"></i> <strong>If Q* > 0:</strong> Dopants move to the <span class="font-bold">COLD</span> side.</li>
                            <li><i class="fas fa-arrow-left text-amber-600 w-6"></i> <strong>If Q* < 0:</strong> Dopants move to the <span class="font-bold">HOT</span> side (Thermophilic).</li>
                        </ul>
                    </div>

                    <h3 class="text-lg font-bold text-slate-700 mt-6 mb-2">B. High-Temperature Accuracy (Bipolar)</h3>
                    <p>To prevent unrealistic $zT$ predictions at high temperatures (where standard models fail), this simulation uses a <strong>Bipolar Correction</strong> calibrated to p-type PbSe data.</p>
                    
                    <ul class="list-disc pl-5 space-y-2 text-slate-600 text-sm">
                        <li>
                            <strong>Effective Band Gap:</strong> We use $E_g \approx 0.28$ eV to calculate minority carrier activation.
                        </li>
                        <li>
                            <strong>Seebeck Suppression:</strong> As $T$ rises, the Seebeck coefficient is reduced by a factor of $\frac{1}{1 + 5\xi}$, where $\xi$ is the bipolar factor. This simulates the "rollover" seen in real experiments.
                        </li>
                        <li>
                            <strong>Thermal Conductivity:</strong> An extra term $\kappa_{bi}$ is added at high $T$, further lowering the $zT$ to realistic limits ($zT_{max} \approx 1.2$).
                        </li>
                    </ul>

                    <h3 class="text-lg font-bold text-slate-700 mt-6 mb-2">C. Numerical Solver</h3>
                    <p class="text-sm text-slate-600">
                        The tool solves the 1D Continuity Equation using an explicit Finite Difference scheme. 
                        Time steps ($\Delta t$) are automatically adjusted to satisfy the CFL stability condition ($\Delta t < 0.4 \Delta x^2 / D_{max}$), ensuring the simulation remains stable even with fast-diffusing dopants (like Ag or Cu).
                    </p>

                </div>
            </div>



        </main>
    </div>

    <!-- Web Worker Code -->
    <script id="worker-code" type="javascript/worker">
        const KB_EV = 8.617333262145e-5; 
        const KB_J = 1.380649e-23;
        const E_CHARGE = 1.60217663e-19;

       // --- PHYSICS MODEL (RE-TUNED v2) ---
        function getProperties(n_cm3, T) {
            // Cap Concentration for safety
            let n_safe = n_cm3;
            if (n_safe < 1e17) n_safe = 1e17;
            if (n_safe > 5e20) n_safe = 5e20;

            const T_norm = T / 300;
            const logN = Math.log10(n_safe);
            
            // 1. Mobility (cm2/Vs)
            // Slightly reduced decay (-2.2) to maintain conductivity at high T
            const mu = 1150 * Math.pow(T_norm, -2.2); 
            
            // 2. Electrical Conductivity (S/cm)
            const sigma = n_safe * 1.602e-19 * mu; 
            
            // 3. Seebeck (Pisarenko with Tuned Bipolar)
            // Base at 300K: ~200 uV/K at 1e19
            const S_base_300K = 400 - 130 * (logN - 18); 
            
            // Linear rise with T (typical for degenerate/SPB)
            // We use (T-300) slope instead of multiplicative T/300 to control ascent
            let S_temp = S_base_300K * (1 + 0.0025 * (T - 300));

            // Bipolar correction
            // Eg ~ 0.28 eV effective gap for bipolar onset
            const E_g = 0.28; 
            const kBT = 8.617e-5 * T;
            const bipolar_factor = Math.exp( -E_g / (2 * kBT) );
            
            // Gentler suppression (factor of 5 instead of 50)
            const S_uV = S_temp / (1 + 5 * bipolar_factor); 
            const S = S_uV * 1e-6; // V/K

            // 4. Thermal Conductivity (W/mK)
            const L_num = 2.4e-8; // Lorenz number
            const k_lat = 1.4 / T_norm; // Lattice (1/T)
            const k_elec = L_num * (sigma * 100) * T; 
            
            // Bipolar Thermal Conductivity (moderate addition)
            const k_bi = 0.2 * (T/300) * bipolar_factor * 100;
            
            const k_tot = k_lat + k_elec + k_bi;

            // 5. ZT Calculation
            // sigma * 100 converts S/cm to S/m
            const ZT = (S * S * (sigma * 100) / k_tot) * T;

            return { S: S_uV, sigma: sigma, k: k_tot, ZT: Math.max(0, ZT) };
        }
      

        self.onmessage = function(e) {
            const p = e.data; 
            
            // 1. DYNAMIC GRID SCALING
            // For very long times, we slightly coarsen the grid to keep simulation interactive
            let N = 70; // Default grid
            if(p.duration_s > 1e8) N = 50; // > ~3 years
            
            const L_m = p.length_mm * 1e-3;
            const dx = L_m / (N - 1);
            const x = new Float64Array(N).map((_, i) => i * dx);

            // 2. Temp Profile
            const T = new Float64Array(N);
            const dT_dx = (p.tCold - p.tHot) / L_m; 
            for(let i=0; i<N; i++) T[i] = p.tHot + (p.tCold - p.tHot) * (i / (N-1));


            // 3. Concentration Init (Robust Error Handling)
            const C = new Float64Array(N);
            const C_new = new Float64Array(N);
            
            const c0_input = String(p.c0);
            let valFunc = null;
            
            // Check if input implies a function (contains 'x')
            if (c0_input.toLowerCase().includes('x')) {
                try {
                    // 1. Try to compile the function
                    // We use a temporary constructor to catch SyntaxErrors (e.g. missing parenthesis)
                    valFunc = new Function('x', `
                        const { exp, log, pow, sin, cos, sqrt } = Math;
                        return ${c0_input};
                    `);

                    // 2. Test Run: Try to execute it once to catch RuntimeErrors (e.g. undefined variable 'y')
                    const testVal = valFunc(0.5);
                    if (isNaN(testVal)) throw new Error("Result is Not a Number (NaN)");

                } catch(e) {
                    // !! STOP SIMULATION AND REPORT ERROR !!
                    self.postMessage({ 
                        type: 'error', 
                        message: "Invalid Formula: " + e.message 
                    });
                    return; // Stop execution here
                }
            } else {
                // Constant number path
                const constVal = parseFloat(c0_input);
                if (isNaN(constVal)) {
                     self.postMessage({ type: 'error', message: "Invalid Number" });
                     return;
                }
                valFunc = () => constVal;
            }

            // Fill Array safely
            for(let i=0; i<N; i++) {
                const x_norm = i / (N-1); 
                let val = valFunc(x_norm);
                if (isNaN(val) || val < 1e15) val = 1e15; // Floor value
                C[i] = val;
            }




            // 4. Time Stepping & Stability
            const maxD = p.d0 * Math.exp(-p.ea / (KB_EV * p.tHot));
            // Stability: dt < 0.5 * dx^2 / D
            // We use 0.4 safety factor
            let dt = 0.4 * (dx * dx) / (maxD + 1e-30);
            
            // Safety cap for dt to ensure we don't jump too fast physically
            // But if diffusion is super slow, dt can be large.
            
            let steps = Math.ceil(p.duration_s / dt);
            
            // HARD LIMIT on Steps to prevent browser freeze
            // If steps > 5,000,000, we must increase dt (and risk some error) or stop.
            // We'll scale dt to fit in 4M steps.
            const MAX_STEPS = 4000000;
            if (steps > MAX_STEPS) {
                dt = p.duration_s / MAX_STEPS;
                steps = MAX_STEPS;
                // Note: This technically violates CFL for explicit Euler if dt gets too big.
                // However, for diffusion, usually D is so small that this condition is rarely hit
                // unless time is geological.
            }

            // 5. History Saving
            // We want ~40 frames for the 3D plot
            const historyInterval = Math.max(1, Math.floor(steps / 40));
            
            // Structures for 3D plots
            const hist_C = [];
            const hist_S = [];
            const hist_ZT = [];
            const hist_Sig = [];
            const timePoints = [];

            // Pre-calc D array (Time independent part)
            const D = new Float64Array(N);
            for(let i=0; i<N; i++) D[i] = p.d0 * Math.exp(-p.ea / (KB_EV * T[i]));

            // Pre-calc Soret Pre-factors
            const SoretFac = new Float64Array(N);
            for(let i=0; i<N; i++) {
                // Term: (Q* / (kB * T^2)) * dT/dx
                SoretFac[i] = (p.qStar / (KB_EV * T[i] * T[i])) * dT_dx;
            }

            // --- SIMULATION LOOP ---
            let t_accum = 0;
            
            for (let t = 0; t <= steps; t++) {
                
                // Flux Calculation (J at i+1/2)
                const Flux = new Float64Array(N-1); 
                for(let i=0; i < N-1; i++) {
                    const C_avg = 0.5 * (C[i] + C[i+1]);
                    const D_avg = 0.5 * (D[i] + D[i+1]);
                    const Soret_avg = 0.5 * (SoretFac[i] + SoretFac[i+1]);
                    
                    const dC_dx = (C[i+1] - C[i]) / dx;
                    
                    const J_soret = -1 * D_avg * C_avg * Soret_avg;
                    const J_fick = -1 * D_avg * dC_dx;
                    
                    Flux[i] = J_fick + J_soret;
                }

                // Update C
                for(let i=1; i < N-1; i++) C_new[i] = C[i] - (dt/dx) * (Flux[i] - Flux[i-1]);
                
                // Boundary Conditions (Zero Flux)
                C_new[0] = C[0] - (dt/dx) * (Flux[0] - 0); 
                C_new[N-1] = C[N-1] - (dt/dx) * (0 - Flux[N-2]);
                
                // Swap
                for(let i=0; i<N; i++) C[i] = C_new[i];
                t_accum += dt;

                // SAVE FRAMES
                if (t % historyInterval === 0 || t === steps) {
                    const row_C = Float64Array.from(C);
                    const row_S = new Float64Array(N);
                    const row_ZT = new Float64Array(N);
                    const row_Sig = new Float64Array(N);
                    
                    for(let k=0; k<N; k++) {
                        const props = getProperties(C[k], T[k]);
                        row_S[k] = props.S;
                        row_ZT[k] = props.ZT;
                        row_Sig[k] = props.sigma;
                    }
                    
                    hist_C.push(row_C);
                    hist_S.push(row_S);
                    hist_ZT.push(row_ZT);
                    hist_Sig.push(row_Sig);
                    timePoints.push(t_accum);
                }

                // Report Progress
                if (t % 50000 === 0) {
                    const pct = Math.round((t/steps)*100);
                    self.postMessage({ type: 'progress', percent: pct });
                }
            }

            self.postMessage({ 
                type: 'complete', 
                x, T, 
                hist_C, hist_S, hist_ZT, hist_Sig, timePoints,
                params: p
            });
        };
    </script>

    <script>
        const PRESETS = {
            'Na': { d0: "2.3e-7", ea: 0.60, qStar: 0.20, c0: "1e19" }, 
            'Ag': { d0: "5.0e-7", ea: 0.45, qStar: 0.15, c0: "5e18" }, 
            'Cl': { d0: "1.0e-8", ea: 0.80, qStar: -0.10, c0: "2e19" }, 
            'custom': { d0: "1.0e-7", ea: 0.5, qStar: 0.0, c0: "1e19" }
        };

        let worker = null;
        let chartConc = null, chartZT = null, chartS = null, chartSigma = null;
        let debounceTimer;

        // --- UTILS ---
        function loadPreset() {
            const key = document.getElementById('presetSelect').value;
            const data = PRESETS[key];
            if(data) {
                document.getElementById('d0').value = data.d0;
                document.getElementById('ea').value = data.ea;
                document.getElementById('qStar').value = data.qStar;
                document.getElementById('c0').value = data.c0;
                debouncedUpdate();
            }
        }

        function switchTab(id) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-' + id).classList.add('active');
            
            document.querySelectorAll('.tab-pane').forEach(p => {
                p.classList.remove('active');
                p.style.display = 'none'; // Ensure strictly hidden
            });
            
            const activePane = document.getElementById('pane-' + id);
            activePane.classList.add('active');
            activePane.style.display = 'flex'; // Ensure strictly shown
            
            // Trigger resize for plots
            window.dispatchEvent(new Event('resize'));
            // Specifically resize Plotly
            const plots = ['plotlyConc', 'plotlyZT', 'plotlyS', 'plotlySigma'];
            plots.forEach(pid => {
                try { Plotly.Plots.resize(pid); } catch(e){}
            });
        }

        function debouncedUpdate() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(triggerSimulation, 600);
        }

        function downloadData() {
            alert("Export feature would go here (CSV generation of history arrays).");
        }

        



        // --- MAIN SIMULATION ---
        function triggerSimulation() {
            if(worker) worker.terminate();
            
            // 1. Reset Error State
            clearError(); 

            // 2. Safely Get Inputs
            // We use a helper check to prevent "null" errors if an ID is missing
            const getVal = (id) => {
                const el = document.getElementById(id);
                if (!el) { console.error("Missing HTML ID:", id); return 0; }
                return parseFloat(el.value);
            };

            const durationInput = getVal('timeValue');
            const durationSeconds = durationInput * 86400;

            const params = {
                tHot: getVal('tHot'),
                tCold: getVal('tCold'),
                length_mm: getVal('legLength'),
                duration_s: durationSeconds,
                d0: getVal('d0'),
                ea: getVal('ea'),
                qStar: getVal('qStar'),
                
                // IMPORTANT: This uses the single "c0" field for everything now.
                // We DO NOT reference 'profileType' or 'profileEq' anymore.
                c0: document.getElementById('c0').value.trim() 
            };

            // 3. Update UI Status
            document.getElementById('status-area').style.opacity = 1;
            document.getElementById('header-status').innerText = "Calculating...";
            document.getElementById('header-progress').style.width = "0%";
            
            // 4. Initialize Worker
            const blob = new Blob([document.getElementById('worker-code').textContent], {type: "text/javascript"});
            worker = new Worker(window.URL.createObjectURL(blob));
            
            // 5. Handle Worker Messages
            worker.onmessage = (e) => {
                if(e.data.type === 'progress') {
                    document.getElementById('header-progress').style.width = e.data.percent + "%";
                }
                else if(e.data.type === 'complete') {
                    document.getElementById('header-progress').style.width = "100%";
                    setTimeout(() => document.getElementById('status-area').style.opacity = 0, 800);
                    renderAll(e.data);
                }
                else if(e.data.type === 'error') {
                    // Stop Status
                    document.getElementById('status-area').style.opacity = 0;
                    document.getElementById('header-progress').style.width = "0%";
                    
                    // Show Error Box
                    const errBox = document.getElementById('conc-error');
                    const errText = document.getElementById('conc-error-text');
                    const inputField = document.getElementById('c0');
                    
                    if(errText) errText.innerText = e.data.message;
                    if(errBox) errBox.style.display = 'block';
                    
                    if(inputField) {
                        inputField.classList.add('border-red-500', 'bg-red-50');
                        inputField.classList.remove('border-emerald-200', 'bg-white');
                    }
                }
            };
            
            worker.postMessage(params);
        }

        function clearError() {
            const errBox = document.getElementById('conc-error');
            const inputField = document.getElementById('c0');
            
            if(errBox) errBox.style.display = 'none';
            
            if(inputField) {
                inputField.classList.remove('border-red-500', 'bg-red-50');
                inputField.classList.add('border-emerald-200', 'bg-white');
            }
        }


        function renderAll(data) {
            const { x, T, hist_C, hist_S, hist_ZT, hist_Sig, timePoints, params } = data;
            const labels = x.map(val => (val*1000).toFixed(1)); // mm

            // 1. Get Snapshot Data
            const initial_C = hist_C[0];                // <--- NEW: Initial State (t=0)
            const final_C = hist_C[hist_C.length-1];    // Final State (t=End)
            const final_S = hist_S[hist_S.length-1];
            const final_ZT = hist_ZT[hist_ZT.length-1];
            const final_Sig = hist_Sig[hist_Sig.length-1];

            // 2. Calculate & Display Average ZT
            const avgZT = final_ZT.reduce((a,b)=>a+b, 0) / final_ZT.length;
            document.getElementById('avg-zt-display').innerText = `Avg ZT: ${avgZT.toFixed(2)}`;

            // --- 2D CHARTS ---
            
            // Chart 1: Concentration Profile (Initial vs Final)
            update2DChart('chartConc', labels, [
                { 
                    label: 'Initial (t=0)', 
                    data: initial_C, 
                    borderColor: '#94a3b8', // Slate Grey
                    borderDash: [5, 5],     // Dashed Line
                    borderWidth: 2,
                    pointRadius: 0,
                    yAxisID: 'y' 
                },
                { 
                    label: 'Final (t=End)', 
                    data: final_C, 
                    borderColor: '#4f46e5', // Indigo Blue
                    borderWidth: 2,
                    pointRadius: 0,
                    yAxisID: 'y' 
                },
                { 
                    label: 'Temperature (K)', 
                    data: T, 
                    borderColor: '#ef4444', // Red
                    borderDash: [2, 2],     // Dotted
                    borderWidth: 1,
                    pointRadius: 0,
                    yAxisID: 'y1' 
                }
            ], 'Conc (cm⁻³)', 'Temp (K)');

            // Chart 2: Figure of Merit ZT
            update2DChart('chartZT', labels, [
                { label: 'Figure of Merit (ZT)', data: final_ZT, borderColor: '#d97706', yAxisID: 'y' }
            ], 'ZT', '');

            // Chart 3: Seebeck Coefficient
            update2DChart('chartS', labels, [
                { label: 'Seebeck (µV/K)', data: final_S, borderColor: '#9333ea', yAxisID: 'y' }
            ], 'Seebeck (µV/K)', '');

            // Chart 4: Conductivity
            update2DChart('chartSigma', labels, [
                { label: 'Conductivity (S/cm)', data: final_Sig, borderColor: '#2563eb', yAxisID: 'y' }
            ], 'Sigma (S/cm)', '');

            // --- 3D PLOTS ---
            // Prepare Axis Data
            const xPlot = x.map(v => v*1000); // mm
            
            // Determine Time Unit (Hours, Days, or Years) based on duration
            const maxTime = timePoints[timePoints.length-1];
            let tDiv = 3600; 
            let tUnit = 'h';
            
            if(maxTime > 3.15e7) {      // > 1 Year
                tDiv = 3.15e7; tUnit = 'y'; 
            } else if(maxTime > 1e5) {  // > ~1 Day
                tDiv = 86400; tUnit = 'd'; 
            }
            
            const yPlot = timePoints.map(t => t/tDiv);

            update3DPlot('plotlyConc', xPlot, yPlot, hist_C, 'Concentration', 'Viridis', tUnit);
            update3DPlot('plotlyZT', xPlot, yPlot, hist_ZT, 'ZT', 'Plasma', tUnit);
            update3DPlot('plotlyS', xPlot, yPlot, hist_S, 'Seebeck (µV/K)', 'Picnic', tUnit);
            update3DPlot('plotlySigma', xPlot, yPlot, hist_Sig, 'Sigma (S/cm)', 'Jet', tUnit);
        }

        // --- CHART HELPERS ---
        const charts = {}; // Store instances

        function update2DChart(canvasId, labels, datasets, yLeft, yRight) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            if(charts[canvasId]) charts[canvasId].destroy();

            const yScales = {
                x: { title: { display:true, text:'Position (mm)' } },
                y: { type:'linear', display:true, position:'left', title:{display:!!yLeft, text:yLeft} }
            };
            if(yRight) {
                yScales.y1 = { type:'linear', display:true, position:'right', grid:{display:false}, title:{display:true, text:yRight} };
            }

            charts[canvasId] = new Chart(ctx, {
                type: 'line',
                data: { labels: labels, datasets: datasets.map(d => ({ ...d, borderWidth:2, pointRadius:0, fill:false })) },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: yScales,
                    interaction: { mode:'index', intersect:false }
                }
            });
        }

        function update3DPlot(divId, xData, yData, zData, zLabel, colorscale, timeUnit) {
            // Convert array of TypedArrays to Array of Arrays
            const zArr = zData.map(row => Array.from(row));
            
            const data = [{
                type: 'surface',
                x: xData,
                y: yData,
                z: zArr,
                colorscale: colorscale,
                showscale: false, // HIDDEN COLOR BAR
                contours: {
                    z: { show:true, usecolormap: true, highlightcolor:"#42f462", project:{z: true} }
                }
            }];

            const layout = {
                title: false,
                autosize: true,
                // Margins updated to prevent overlap with mode bar
                margin: {l:50, r:20, b:50, t:50},
                scene: {
                    xaxis: {title: 'Pos (mm)'},
                    yaxis: {title: `Time (${timeUnit})`},
                    zaxis: {title: zLabel},
                    camera: { eye: {x: -1.7, y: -1.7, z: 1.2} }
                }
            };
            
            const config = { displaylogo: false, responsive: true };
            
            Plotly.react(divId, data, layout, config);
        }

        window.onload = function() { triggerSimulation(); }
        window.onresize = function() { 
            Object.values(charts).forEach(c => c.resize());
            ['plotlyConc', 'plotlyZT', 'plotlyS', 'plotlySigma'].forEach(id => {
                try { Plotly.Plots.resize(id); } catch(e){}
            });
        }
    </script>
</body>
</html>