<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Onsager Diffusion v8.0 (3D Flux)</title>
    <link href="./dist/output.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    
    <script>
    window.MathJax = {
      tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] }
    };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        /* Custom scrollbar for cleanliness */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .tab-btn.active { background-color: #eff6ff; color: #2563eb; border-bottom: 2px solid #2563eb; }
        .tab-btn { color: #64748b; padding: 0 1rem; transition: all 0.2s; font-weight: 600; font-size: 0.875rem; }
        .tab-pane { display: none; height: 100%; width: 100%; }
        .tab-pane.active { display: block; }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-800 bg-slate-50 font-sans">

    <div class="bg-white border-b border-gray-200 px-4 flex items-center justify-between shrink-0 h-14 shadow-sm z-20">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-orange-600 rounded flex items-center justify-center text-white font-bold shadow-md">
                <i class="fas fa-project-diagram"></i>
            </div>
            <h1 class="font-bold text-lg text-slate-800 hidden md:block">Onsager Diffusion <span class="text-xs font-normal text-slate-500 ml-1">v8.0 (3D Flux)</span></h1>
        </div>
        
        <div id="status-area" class="flex-1 mx-8 flex items-center gap-3 opacity-0 transition-opacity duration-300">
            <div class="h-1.5 flex-1 bg-gray-100 rounded-full overflow-hidden">
                <div id="header-progress" class="h-full bg-orange-500 w-0 transition-all duration-200"></div>
            </div>
            <span id="header-status" class="text-xs font-mono text-gray-400 w-24 text-right">Calculating...</span>
            <button onclick="terminateWorker()" class="text-xs text-red-500 hover:text-red-700 font-bold uppercase" title="Stop">
                <i class="fas fa-stop"></i>
            </button>
        </div>

        <div class="flex space-x-1 h-full overflow-x-auto mx-4">
            <button onclick="switchTab('profile')" id="tab-profile" class="tab-btn active h-full flex items-center">
                <i class="fas fa-chart-line mr-2"></i> Profile
            </button>
            <button onclick="switchTab('flux')" id="tab-flux" class="tab-btn h-full flex items-center">
                <i class="fas fa-water mr-2"></i> 3D Flux
            </button>
            <button onclick="switchTab('time3d')" id="tab-time3d" class="tab-btn h-full flex items-center">
                <i class="fas fa-cube mr-2"></i> 3D Conc
            </button>
            <button onclick="switchTab('help')" id="tab-help" class="tab-btn h-full flex items-center text-emerald-600">
                <i class="fas fa-info-circle mr-2"></i> Theory
            </button>
        </div>
    </div>

    <div class="flex flex-1 overflow-hidden relative">
        
        <aside class="w-full md:w-80 bg-white border-r border-gray-200 flex flex-col h-full z-10 shadow-[4px_0_24px_rgba(0,0,0,0.02)] shrink-0 overflow-y-auto">
            <div class="p-4 space-y-5">
                
                <div class="bg-orange-50 p-4 rounded-lg border border-orange-200 shadow-sm">
                    <div class="flex items-center gap-2 mb-3 border-b border-orange-200 pb-2">
                        <i class="fas fa-ruler-combined text-orange-600"></i>
                        <h3 class="text-xs font-bold text-orange-800 uppercase tracking-wider">1. Geometry</h3>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="input-group">
                            <label class="text-[10px] text-orange-700 font-bold block mb-1">Source Lenght (µm)</label>
                            <input type="number" id="sourceLength" value="5" min="0.1" step="0.1" class="w-full text-sm border border-orange-300 rounded p-1.5 font-semibold bg-white text-orange-900 focus:ring-2 focus:ring-orange-200 outline-none" onchange="debouncedUpdate()">
                        </div>
                        <div class="input-group">
                            <label class="text-[10px] text-orange-700 font-bold block mb-1">Total Length (µm)</label>
                            <input type="number" id="totalLength" value="20" min="1" step="1" class="w-full text-sm border border-orange-300 rounded p-1.5 font-semibold bg-white text-orange-900 focus:ring-2 focus:ring-orange-200 outline-none" onchange="debouncedUpdate()">
                        </div>
                        <div class="input-group col-span-2">
                            <label class="text-[10px] text-orange-700 font-bold block mb-1">Grid Points</label>
                            <input type="number" id="gridPoints" value="100" min="50" max="400" class="w-full text-sm border border-orange-300 rounded p-1.5 font-semibold bg-white focus:ring-2 focus:ring-orange-200 outline-none" onchange="debouncedUpdate()">
                        </div>
                    </div>
                </div>

                <div class="bg-slate-50 p-3 rounded border border-slate-200">
                    <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">2. Conditions</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="input-group">
                            <label class="text-[10px] text-gray-500 font-bold block">Temp (K)</label>
                            <input type="number" id="temp" value="1050" min="600" max="2800" class="w-full text-sm border border-gray-300 rounded p-1" onchange="debouncedUpdate()">
                        </div>
                        <div class="input-group">
                            <label class="text-[10px] text-gray-500 font-bold block">Time (Hours)</label>
                            <input type="number" id="time" value="72" min="0.1" step="0.1" class="w-full text-sm border border-gray-300 rounded p-1" onchange="debouncedUpdate()">
                        </div>
                    </div>
                </div>

                <div class="bg-indigo-50 p-3 rounded border border-indigo-100">
                    <h3 class="text-xs font-bold text-indigo-800 uppercase tracking-wider mb-2">3. Matrix (MgO)</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-[10px] text-indigo-600 font-bold block">D₀ (m²/s)</label>
                            <input type="text" id="targetD0" value="5.0e-11" class="w-full text-xs border border-indigo-200 rounded p-1" onchange="debouncedUpdate()">
                        </div>
                        <div>
                            <label class="text-[10px] text-indigo-600 font-bold block">Q (eV)</label>
                            <input type="number" id="targetQ" value="2.0" step="0.1" class="w-full text-xs border border-indigo-200 rounded p-1" onchange="debouncedUpdate()">
                        </div>
                    </div>
                </div>

                <div>
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider">4. Dopants</h3>
                        <button onclick="addElement()" class="text-[10px] bg-indigo-600 hover:bg-indigo-700 text-white px-2 py-1 rounded transition shadow-sm font-bold">
                            <i class="fas fa-plus"></i> ADD
                        </button>
                    </div>
                    <div id="elementsList" class="space-y-3"></div>
                    <button onclick="downloadData()" class="mt-4 w-full text-xs bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 rounded">
                        <i class="fas fa-download mr-1"></i> Download CSV
                    </button>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col h-full relative bg-slate-100 overflow-hidden">
            
            <div id="pane-profile" class="tab-pane active relative p-4">
                <div class="bg-white w-full h-full rounded-lg shadow-sm border border-gray-200 p-4 flex flex-col">
                    <div class="flex-1 relative">
                        <canvas id="diffusionChart"></canvas>
                    </div>
                </div>
            </div>

            <div id="pane-flux" class="tab-pane relative">
                 <div id="plotly-flux" class="w-full h-full"></div>
            </div>

            <div id="pane-time3d" class="tab-pane relative">
                 <div id="plotly-time" class="w-full h-full"></div>
            </div>



            <div id="pane-help" class="tab-pane overflow-y-auto p-8 bg-white">
    <div class="max-w-4xl mx-auto pb-20 help-content">
        
        <div class="border-b border-gray-200 pb-4 mb-6">
            <h1 class="text-3xl font-bold text-slate-800">Documentation & Theory</h1>
            <p class="text-slate-500 mt-2">Onsager Multi-Component Diffusion Solver (v8.4)</p>
        </div>

        <div class="bg-amber-50 border-l-4 border-amber-500 p-4 mb-8 shadow-sm rounded-r">
            <div class="flex items-start">
                <div class="shrink-0 text-amber-600 mt-1"><i class="fas fa-exclamation-triangle"></i></div>
                <div class="ml-3">
                    <h3 class="text-sm font-bold text-amber-800 uppercase tracking-wide">Parameter Warning</h3>
                    <p class="text-sm text-amber-900 mt-1">
                        Default values ($D_0, Q$) are approximations for <strong>MgO</strong>. For other systems you must update these values. This tool assumes that D0 and Q do not change with concentration.
                    </p>
                </div>
            </div>
        </div>

        <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
            <span class="w-8 h-8 rounded bg-indigo-100 text-indigo-600 flex items-center justify-center text-sm">1</span>
            Thermodynamics: The $L$ vs. $D$ Matrix
        </h2>
        
        <p class="text-slate-600 mb-4">
            This tool solves the transport equations using concentration gradients, which leads to an <strong>asymmetric</strong> diffusion matrix.
        </p>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div class="bg-slate-50 p-4 rounded border border-slate-200">
                <h4 class="font-bold text-slate-700 mb-2">The Onsager Matrix ($L$)</h4>
                <div class="text-center bg-white p-2 rounded border border-slate-100 mb-3 text-sm">
                    $$ J_i = - \sum_{j} L_{ij} \nabla \mu_j $$
                </div>
                <p class="text-xs text-slate-500">
                    Driven by Chemical Potential ($\mu$).<br>
                    <strong>Symmetric ($L_{ij} = L_{ji}$)</strong> due to microscopic time reversibility (Onsager Reciprocal Relations).
                </p>
            </div>

            <div class="bg-indigo-50 p-4 rounded border border-indigo-200">
                <h4 class="font-bold text-indigo-700 mb-2">The Diffusion Matrix ($D$)</h4>
                <div class="text-center bg-white p-2 rounded border border-indigo-100 mb-3 text-sm">
                    $$ J_i = - \sum_{j} D_{ij} \nabla C_j $$
                </div>
                <p class="text-xs text-indigo-800">
                    Driven by Concentration ($C$).<br>
                    <strong>Asymmetric ($D_{ij} \neq D_{ji}$)</strong> because it combines the symmetric $L$ matrix with the thermodynamic properties of the material ($D = L \cdot \frac{\partial \mu}{\partial C}$).
                </p>
            </div>
        </div>

        <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
            <span class="w-8 h-8 rounded bg-orange-100 text-orange-600 flex items-center justify-center text-sm">2</span>
            The Manning-Darken Approximation
        </h2>

        <p class="text-slate-600 mb-4">
            This tool calculates the $D_{ij}$ terms dynamically at every grid point using the Manning-Darken formalism for vacancy-mediated diffusion. The asymmetry arises physically from the <strong>Vacancy Wind Effect</strong>.
        </p>

        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden mb-8 shadow-sm">
            <table class="w-full text-sm text-left">
                <thead class="bg-gray-50 text-gray-700 border-b">
                    <tr>
                        <th class="px-4 py-2">Term</th>
                        <th class="px-4 py-2">Formula</th>
                        <th class="px-4 py-2">Physical Meaning</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    <tr>
                        <td class="px-4 py-3 font-mono text-indigo-600 font-bold">Diagonal ($D_{ii}$)</td>
                        <td class="px-4 py-3 font-mono text-xs">$$D^*_i + C_i (D^*_{matrix} - D^*_i)$$</td>
                        <td class="px-4 py-3 text-slate-600 text-xs">
                            Tracer diffusion modified by the net flow of the matrix.
                        </td>
                    </tr>
                    <tr class="bg-orange-50/30">
                        <td class="px-4 py-3 font-mono text-orange-600 font-bold">Off-Diagonal ($D_{ij}$)</td>
                        <td class="px-4 py-3 font-mono text-xs">$$C_i (D^*_{matrix} - D^*_j)$$</td>
                        <td class="px-4 py-3 text-slate-600 text-xs">
                            <strong>Vacancy Wind:</strong> If species $j$ is fast ($D^*_j$ high), it creates a vacancy wind that drags species $i$. This is asymmetric because $C_i \neq C_j$.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
            <span class="w-8 h-8 rounded bg-emerald-100 text-emerald-600 flex items-center justify-center text-sm">3</span>
            Numerical Algorithm & Stability
        </h2>
        
        <div class="prose prose-sm text-slate-600 bg-slate-50 p-5 rounded border border-slate-200 mb-8">
            <p class="mb-2">
                The coupled Partial Differential Equations (PDEs) are solved by using an Explicit Finite Difference Method. 
                Because the equations are coupled (the motion of one element depends on all others), simple stability checks fail.
            </p>
            
            <h4 class="font-bold text-slate-800 mt-4">Robust Stability: Spectral Radius Control</h4>
            <p>
                To ensure the simulation does not "explode", the timestep $\Delta t$ is calculated by using <strong>Gershgorin's Circle Theorem</strong> to estimate the maximum Eigenvalue ($\lambda_{max}$) of the diffusion matrix at every step:
            </p>
            
            <div class="my-4 bg-white p-3 rounded border border-slate-300 text-center font-mono text-slate-800">
                $$ \Delta t \leq \frac{\Delta x^2}{2 \cdot \lambda_{max}} \quad \text{where} \quad \lambda_{max} \approx \max_i \sum_j |D_{ij} \cdot \Phi_i| $$
            </div>

            <p>
                This ensures that even if you pair a very fast dopant with a very slow one (strong coupling) or use non-ideal thermodynamics, the solver remains mathematically rigorous.
            </p>
        </div>

        <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
            <span class="w-8 h-8 rounded bg-blue-100 text-blue-600 flex items-center justify-center text-sm">4</span>
            Visualizing data
        </h2>

        <div class="space-y-4 mb-8">
            <div class="bg-white border border-gray-200 p-4 rounded-lg shadow-sm flex flex-col md:flex-row gap-4">
                <div class="shrink-0 w-12 h-12 bg-blue-50 text-blue-500 rounded-full flex items-center justify-center text-lg self-center md:self-start">
                    <i class="fas fa-water"></i>
                </div>
                <div>
                    <h4 class="font-bold text-slate-800">3D Flux View (Surface Plot)</h4>
                    <p class="text-sm text-slate-600 mt-1">
                        Visualizes the net flow of atoms $J(x,t)$. 
                    </p>
                    <ul class="text-xs text-slate-500 mt-2 space-y-1 list-disc pl-4">
                        <li><strong>The "Wall":</strong> A massive flux spike at T=0 where gradients are infinite.</li>
                        <li><strong>Coupling Signs:</strong> If a slow element moves "uphill" (negative flux against its own gradient), it creates a dip in the surface, visually proving the Onsager cross-terms are active.</li>
                    </ul>
                </div>
            </div>

            <div class="bg-white border border-gray-200 p-4 rounded-lg shadow-sm flex flex-col md:flex-row gap-4">
                <div class="shrink-0 w-12 h-12 bg-purple-50 text-purple-500 rounded-full flex items-center justify-center text-lg self-center md:self-start">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div>
                    <h4 class="font-bold text-slate-800">Concentration Profile (2D)</h4>
                    <p class="text-sm text-slate-600 mt-1">
                        The classic "Diffusion Profile".
                    </p>
                    <ul class="text-xs text-slate-500 mt-2 space-y-1 list-disc pl-4">
                        <li><strong>Uphill Diffusion:</strong> Look for "bumps" near the interface. This is the fast element "stealing" vacancies from the slow element.</li>
                        <li><strong>Kirkendall Shift:</strong> Asymmetry in the profiles indicates the lattice plane is physically moving to compensate for unequal flux.</li>
                    </ul>
                </div>
            </div>
        </div>

        <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
            <span class="w-8 h-8 rounded bg-rose-100 text-rose-600 flex items-center justify-center text-sm">5</span>
            Non-Ideal Thermodynamics ($\Omega \neq 0$)
        </h2>

        <div class="bg-rose-50 border border-rose-100 p-6 rounded mb-8">
            <p class="text-slate-700 text-sm mb-4">
                Fick's Law assumes a "Dilute Solution" (Ideal Gas behavior, $\gamma=1$). In real alloys, atoms interact chemically. We model this using the <strong>Regular Solution Model</strong> via the Interaction Parameter $\Omega$ (Omega).
            </p>

            <h4 class="font-bold text-rose-800 text-sm mb-2 uppercase tracking-wide">1. The Thermodynamic Factor ($\Phi$)</h4>
            <p class="text-sm text-slate-600 mb-3">
                Flux is driven by the gradient of Chemical Potential ($\mu$), not just concentration. We calculate a correction factor $\Phi$ at every grid point:
            </p>
            <div class="text-center bg-white p-3 rounded border border-rose-200 mb-4 font-mono text-rose-900 text-sm">
                $$ \Phi = 1 - \frac{2 \Omega C (1-C)}{k_B T} $$
                <div class="text-xs text-slate-400 mt-1">Then, $J_{actual} = J_{onsager} \times \Phi$</div>
            </div>

            <h4 class="font-bold text-rose-800 text-sm mb-2 uppercase tracking-wide">2. The Meaning of Omega ($\Omega$)</h4>
            <p class="text-sm text-slate-600 mb-4">
                The parameter $\Omega$ describes the enthalpy of mixing between the Dopant and the Matrix.
            </p>

            <div class="space-y-3">
                <div class="bg-white p-4 rounded shadow-sm border-l-4 border-indigo-500">
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-bold text-indigo-700 text-sm">Case A: Ordering ($\Omega < 0$)</span>
                        <span class="font-mono text-xs bg-indigo-50 text-indigo-700 px-2 py-1 rounded">$\Phi > 1$</span>
                    </div>
                    <p class="text-xs text-slate-600">
                        The dopant atoms are attracted to the matrix atoms. 
                        <br><strong>Effect:</strong> The thermodynamic driving force is increased. Diffusion appears <strong>faster</strong> or gradients become steeper as atoms rush to mix.
                    </p>
                </div>

                <div class="bg-white p-4 rounded shadow-sm border-l-4 border-amber-500">
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-bold text-amber-700 text-sm">Case B: Clustering ($\Omega > 0$)</span>
                        <span class="font-mono text-xs bg-amber-50 text-amber-700 px-2 py-1 rounded">$0 < \Phi < 1$</span>
                    </div>
                    <p class="text-xs text-slate-600">
                        The dopant atoms repel the matrix.
                        <br><strong>Effect:</strong> The driving force is reduced. Diffusion is <strong>suppressed</strong> (sluggish).
                    </p>
                </div>

                <div class="bg-white p-4 rounded shadow-sm border-l-4 border-rose-600">
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-bold text-rose-700 text-sm">Case C: Spinodal Decomposition ($\Omega \gg 0$)</span>
                        <span class="font-mono text-xs bg-rose-50 text-rose-700 px-2 py-1 rounded">$\Phi < 0$</span>
                    </div>
                    <p class="text-xs text-slate-600">
                        If repulsion is very high and Temperature is low ($2\Omega > 4 k_B T$), the system becomes unstable.
                        <br><strong>Effect:</strong> <strong>Negative Diffusion</strong>. Atoms flow from Low Concentration $\to$ High Concentration. The material spontaneously un-mixes (phase separation).
                    </p>
                </div>
            </div>
        </div>

        <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
            <span class="w-8 h-8 rounded bg-cyan-100 text-cyan-600 flex items-center justify-center text-sm">6</span>
            Reference Values for MgO Matrix
        </h2>

        <div class="bg-cyan-50 border-l-4 border-cyan-500 p-5 rounded mb-8 shadow-sm">
            <p class="text-sm text-slate-700 mb-4">
                The values below are compiled from experimental thermodynamic assessments of oxide solid solutions.
                <br><span class="text-xs text-slate-500">Note: $1 \text{ kJ/mol} \approx 0.0104 \text{ eV}$.</span>
            </p>

            <div class="overflow-x-auto">
                <table class="w-full text-left text-xs">
                    <thead class="bg-cyan-100 text-cyan-900 font-bold uppercase border-b border-cyan-200">
                        <tr>
                            <th class="px-3 py-2">Dopant (Oxide)</th>
                            <th class="px-3 py-2">$\Omega$ (eV)</th>
                            <th class="px-3 py-2">Behavior</th>
                            <th class="px-3 py-2">Notes</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-cyan-100 bg-white">
                        <tr class="hover:bg-cyan-50/50">
                            <td class="px-3 py-2 font-bold text-slate-700">NiO (Ni²⁺)</td>
                            <td class="px-3 py-2 font-mono text-emerald-600">0.00</td>
                            <td class="px-3 py-2">Ideal</td>
                            <td class="px-3 py-2 text-slate-500">Complete solid solution.</td>
                        </tr>
                        <tr class="hover:bg-cyan-50/50">
                            <td class="px-3 py-2 font-bold text-slate-700">CoO (Co²⁺)</td>
                            <td class="px-3 py-2 font-mono text-emerald-600">0.05</td>
                            <td class="px-3 py-2">Near Ideal</td>
                            <td class="px-3 py-2 text-slate-500">Very slight repulsion ($\approx 5$ kJ/mol).</td>
                        </tr>
                        <tr class="hover:bg-cyan-50/50">
                            <td class="px-3 py-2 font-bold text-slate-700">FeO (Fe²⁺)</td>
                            <td class="px-3 py-2 font-mono text-emerald-600">0.04</td>
                            <td class="px-3 py-2">Near Ideal</td>
                            <td class="px-3 py-2 text-slate-500">Mixes well at high Temp.</td>
                        </tr>
                        <tr class="hover:bg-cyan-50/50">
                            <td class="px-3 py-2 font-bold text-slate-700">MnO (Mn²⁺)</td>
                            <td class="px-3 py-2 font-mono text-emerald-600">0.04</td>
                            <td class="px-3 py-2">Near Ideal</td>
                            <td class="px-3 py-2 text-slate-500">Similar radius to Mg²⁺.</td>
                        </tr>


                        <tr class="hover:bg-cyan-50/50">
    <td class="px-3 py-2 font-bold text-slate-700">CuO (Cu²⁺)</td>
    <td class="px-3 py-2 font-mono text-amber-600">0.21</td>
    <td class="px-3 py-2">Repulsive</td>
    <td class="px-3 py-2 text-slate-500">
        Jahn-Teller ion. Distorts the local MgO lattice, reducing solubility.
    </td>
</tr>

<tr class="hover:bg-cyan-50/50">
    <td class="px-3 py-2 font-bold text-slate-700">ZnO (Zn²⁺)</td>
    <td class="px-3 py-2 font-mono text-amber-600">0.18</td>
    <td class="px-3 py-2">Repulsive</td>
    <td class="px-3 py-2 text-slate-500">
        Structural mismatch. Zn prefers tetrahedral coord (Wurtzite) vs Mg octahedral (Rock Salt).
    </td>
</tr>


                        <tr class="bg-slate-50 hover:bg-slate-100 border-t border-slate-200">
                            <td class="px-3 py-2 font-bold text-slate-700">Cr₂O₃ (Cr³⁺)</td>
                            <td class="px-3 py-2 font-mono text-purple-600">> 0.80</td>
                            <td class="px-3 py-2">Solubility Limit</td>
                            <td class="px-3 py-2 text-slate-500">Forms Spinel (MgCr₂O₄). Treats MgO as matrix.</td>
                        </tr>
                        <tr class="bg-slate-50 hover:bg-slate-100">
                            <td class="px-3 py-2 font-bold text-slate-700">Al₂O₃ (Al³⁺)</td>
                            <td class="px-3 py-2 font-mono text-purple-600">> 1.00</td>
                            <td class="px-3 py-2">Solubility Limit</td>
                            <td class="px-3 py-2 text-slate-500">Very low solubility in Periclase.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <p class="text-[10px] text-slate-400 mt-2 italic">
                * For 3+ ions (Cr, Al, Fe³⁺), the "Regular Solution" model is an approximation. A high positive $\Omega$ effectively simulates their low solubility limit.
            </p>
        </div>



    </div>
</div>




        </main>
    </div>

    <template id="elementTemplate">
    <div class="element-card bg-white p-3 rounded border border-gray-300 shadow-sm relative group border-l-4 mb-2">
        <input type="hidden" class="el-color">
        <button class="delete-btn absolute top-1 right-2 text-gray-300 hover:text-red-500 hidden group-hover:block transition" title="Remove">
            <i class="fas fa-times"></i>
        </button>
        <div class="grid grid-cols-3 gap-2 mb-2"> <div class="col-span-3">
                <label class="text-[10px] text-gray-500 font-bold block">Dopant</label>
                <select class="el-name border border-gray-300 rounded text-xs w-full p-1 font-semibold text-slate-700" onchange="updateElementParams(this)">
                </select>
            </div>
            <div>
                <label class="text-[10px] text-gray-500 font-bold block">D*₀</label>
                <input type="text" class="el-d0 text-xs border border-gray-300 rounded p-1 w-full" onchange="debouncedUpdate()">
            </div>
            <div>
                <label class="text-[10px] text-gray-500 font-bold block">Q (eV)</label>
                <input type="number" class="el-q text-xs border border-gray-300 rounded p-1 w-full" step="0.1" onchange="debouncedUpdate()">
            </div>
            <div>
                <label class="text-[10px] text-gray-500 font-bold block text-rose-600">Ω (eV)</label>
                <input type="number" class="el-omega text-xs border border-rose-200 bg-rose-50 rounded p-1 w-full font-bold text-rose-800" value="0" step="0.01" onchange="debouncedUpdate()">
            </div>
            <div class="col-span-1.5"> <label class="text-[10px] text-gray-500 font-bold block">Source %</label>
                <input type="number" class="el-c-left text-xs border border-gray-300 rounded p-1 w-full" min="0" max="100" onchange="debouncedUpdate()">
            </div>
            <div class="col-span-1.5"> <label class="text-[10px] text-gray-500 font-bold block">Matrix %</label>
                <input type="number" class="el-c-right text-xs border border-gray-300 rounded p-1 w-full" min="0" max="100" onchange="debouncedUpdate()">
            </div>
        </div>
    </div>
</template>


<script id="worker-code" type="javascript/worker">
    const KB_EV = 8.617333262145e-5; 

    self.onmessage = function(e) {
        const inputs = e.data;
        try {
            // --- 1. SETUP PARAMETERS ---
            const Temp = inputs.temp;
            const kBT = KB_EV * Temp;
            const Time_s = inputs.timeHours * 3600;
            const N = inputs.N;
            const L_m = inputs.totalLength * 1e-6; 
            const Source_m = inputs.sourceLength * 1e-6;
            const dx = L_m / (N - 1);
            
            const interfaceNode = Math.round(Source_m / dx);

            // Matrix Properties
            const matExp = -inputs.targetQ / (kBT);
            const D_star_matrix = inputs.targetD0 * Math.exp(matExp);

            // Initialize Species
            const species = inputs.elements.map(el => {
                const exp = -el.q / (kBT);
                const D_star = el.d0 * Math.exp(exp);
                const C = new Float64Array(N);
                
                // Initial Step Profile
                for(let i=0; i<N; i++) {
                    C[i] = (i < interfaceNode) ? el.cLeft / 100 : el.cRight / 100;
                }

                return { 
                    ...el, 
                    D_star, 
                    omega: el.omega || 0, // Default to 0 if undefined
                    C, 
                    C_new: new Float64Array(N), 
                    Flux: new Float64Array(N), 
                    history: [],
                    fluxHistory: [] 
                };
            });

            // --- 2. TIME INTEGRATION LOOP ---
            
            // Initial Time Step Guess
            let maxD_initial = getSpectralRadius(species, D_star_matrix, N);
            let dt = (0.4 * dx * dx) / maxD_initial;
            let current_time = 0;
            
            // Loop counters
            let step = 0;
            
            // Optimization: Save intervals
            const estimatedSteps = Math.ceil(Time_s / dt);
            const saveInterval = Math.max(1, Math.floor(estimatedSteps / 40)); 
            const reportInterval = Math.max(100, Math.floor(estimatedSteps / 50));

            while (current_time < Time_s) {
                
                // A. Dynamic Stability Check (Recalculate dt every 100 steps to adjust for changing gradients)
                if (step % 100 === 0) {
                    const maxEigenvalue = getSpectralRadius(species, D_star_matrix, N);
                    // CFL Condition: dt <= dx^2 / (2 * D)
                    // We use 0.4 for safety margin
                    dt = (0.4 * dx * dx) / maxEigenvalue;
                }

                // Ensure we don't overshoot the final time
                if (current_time + dt > Time_s) dt = Time_s - current_time;

                // B. Flux Calculation (Fick's 1st Law + Onsager + Thermodynamics)
                for (let i = 0; i < N - 1; i++) {
                    // Local properties at the interface between node i and i+1
                    const C_local = species.map(s => (s.C[i] + s.C[i+1]) / 2);
                    const grads = species.map(s => (s.C[i+1] - s.C[i]) / dx);
                    
                    species.forEach((s_i, idx_i) => {
                        let flux_onsager = 0;
                        
                        // 1. Calculate Onsager Matrix Terms (D_ij)
                        species.forEach((s_j, idx_j) => {
                            let D_ij = 0;
                            if (idx_i === idx_j) {
                                // Diagonal: Self-Diffusion + Matrix Drag
                                D_ij = s_i.D_star + C_local[idx_i] * (D_star_matrix - s_i.D_star);
                            } else {
                                // Off-Diagonal: Vacancy Wind Effect (Cross-term)
                                D_ij = C_local[idx_i] * (D_star_matrix - s_j.D_star);
                            }
                            flux_onsager += -1 * D_ij * grads[idx_j];
                        });

                        // 2. Calculate Thermodynamic Factor (Phi)
                        // Regular Solution Model: Phi = 1 - [2 * Omega * C * (1-C) / kT]
                        // Note: If Omega is 0 (Ideal), Phi = 1.
                        const conc = C_local[idx_i];
                        const term = (2 * s_i.omega * conc * (1 - conc)) / kBT;
                        const Phi = 1 - term;

                        // 3. Apply Correction
                        s_i.Flux[i] = flux_onsager * Phi;
                    });
                }

                // C. Conservation of Mass (Fick's 2nd Law)
                for (let i = 1; i < N - 1; i++) {
                    species.forEach(s => {
                        const dJ_dx = (s.Flux[i] - s.Flux[i-1]) / dx;
                        s.C_new[i] = s.C[i] - dt * dJ_dx;
                    });
                }

                // D. Boundary Conditions (No Flux / Reflective)
                species.forEach(s => { 
                    s.C_new[0] = s.C_new[1]; 
                    s.C_new[N-1] = s.C_new[N-2]; 
                });

                // E. Update & History
                species.forEach(s => {
                    // Swap Arrays
                    const temp = s.C; s.C = s.C_new; s.C_new = temp;
                    
                    if (inputs.mode === 'history' && step % saveInterval === 0) {
                        s.history.push(Float64Array.from(s.C));
                        s.fluxHistory.push(Float64Array.from(s.Flux));
                    }
                });

                current_time += dt;
                step++;

                if (step % reportInterval === 0) {
                    const percent = Math.min(100, Math.round((current_time / Time_s) * 100));
                    self.postMessage({ type: 'progress', percent: percent });
                }
            }

            // --- 3. FINALIZE ---
            const finalMatrix = new Float64Array(N);
            for(let i=0; i<N; i++) {
                let sum = 0;
                species.forEach(s => sum += s.C[i]);
                finalMatrix[i] = Math.max(0, 1 - sum);
            }

            self.postMessage({ type: 'complete', species, matrix: finalMatrix, dx, interfaceX: Source_m });
        } catch (err) {
            self.postMessage({ type: 'error', message: err.message + " (Check Omega/Stability)" });
        }
    };

    /**
     * Calculates the Spectral Radius (Max Eigenvalue) of the Diffusion Matrix
     * Uses Gershgorin Circle Theorem for a safe upper bound.
     * Essential for stability in coupled multi-component systems.
     */
    function getSpectralRadius(species, D_star_matrix, N) {
        let maxEigenvalue = 0;

        // Scan grid (sparse scan for performance, scanning every 5th point is usually sufficient)
        // But for safety in this version, we scan the full grid.
        for (let x = 0; x < N; x++) {
            
            // For each species row i
            for (let i = 0; i < species.length; i++) {
                let rowSum = 0;
                const C_i = species[i].C[x];
                
                // Sum absolute values of all interaction terms
                for (let j = 0; j < species.length; j++) {
                    let D_ij = 0;
                    if (i === j) {
                        D_ij = species[i].D_star + C_i * (D_star_matrix - species[i].D_star);
                    } else {
                        D_ij = C_i * (D_star_matrix - species[j].D_star);
                    }
                    rowSum += Math.abs(D_ij);
                }
                
                // Apply Gamma correction roughly to the max Eigenvalue for safety
                // If Phi is large (>1), we need smaller timesteps.
                // If Phi is negative (Spinodal), we technically can't be stable with Explicit Euler, 
                // but we take abs() to prevent crash.
                let phi_est = 1.0;
                if (species[i].omega !== 0) {
                   // Worst case estimation for phi
                   phi_est = Math.max(1, Math.abs(1 - (2 * species[i].omega * 0.25) / (KB_EV * 2000))); 
                }

                if (rowSum * phi_est > maxEigenvalue) maxEigenvalue = rowSum * phi_est;
            }
        }
        
        return Math.max(maxEigenvalue, 1e-35);
    }
</script>



<script>
    let worker = null;
    let chartInstance = null;
    let currentTab = 'profile';
    let debounceTimer;

    // --- GLOBAL STORAGE FOR EXPORT ---
    let lastResults = null;
    let lastInputs = null;

    // --- 3D TRANSITION METAL SERIES (Estimated for MgO) ---
    const CATION_DB = {
        "Sc": { label: "Sc³⁺ (Scandium)",   d0: "4.0e-10", q: 1.6 },
        "Ti": { label: "Ti⁴⁺ (Titanium)",   d0: "8.0e-10", q: 1.5 },
        "V":  { label: "V³⁺ (Vanadium)",    d0: "6.0e-10", q: 1.6 },
        "Cr": { label: "Cr³⁺ (Chromium)",   d0: "3.5e-10", q: 1.7 },
        "Mn": { label: "Mn²⁺ (Manganese)",  d0: "1.5e-10", q: 1.8 },
        "Fe": { label: "Fe²⁺ (Iron)",       d0: "1.2e-9",  q: 1.6 },
        "Co": { label: "Co²⁺ (Cobalt)",     d0: "5.0e-10", q: 1.7 },
        "Ni": { label: "Ni²⁺ (Nickel)",     d0: "2.5e-10", q: 1.8 },
        "Cu": { label: "Cu²⁺ (Copper)",     d0: "3.0e-10", q: 1.7 },
        "Zn": { label: "Zn²⁺ (Zinc)",       d0: "8.0e-10", q: 1.6 }
    };

    function createWorker() {
        const blob = new Blob([document.getElementById('worker-code').textContent], {type: "text/javascript"});
        return new Worker(window.URL.createObjectURL(blob));
    }

    function terminateWorker() {
        if (worker) { worker.terminate(); worker = null; updateStatus(0, "Stopped"); }
    }

    function updateStatus(percent, text) {
        const area = document.getElementById('status-area');
        const bar = document.getElementById('header-progress');
        const lbl = document.getElementById('header-status');
        if(text === 'Ready') { area.style.opacity = '0'; } 
        else { area.style.opacity = '1'; bar.style.width = percent + '%'; lbl.innerText = text || (percent + '%'); }
    }

    function triggerCalculation() {
        const inputs = validateInputs();
        if(!inputs) return;
        terminateWorker();
        
        // Enable 'history' mode for both Flux and Time3D tabs
        inputs.mode = (currentTab === 'time3d' || currentTab === 'flux') ? 'history' : 'snapshot';
        
        worker = createWorker();
        worker.onmessage = function(e) {
            const msg = e.data;
            if (msg.type === 'progress') { updateStatus(msg.percent, msg.percent + '%'); } 
            else if (msg.type === 'complete') {
                updateStatus(100, 'Done');
                setTimeout(() => updateStatus(0, 'Ready'), 1000);
                renderResults(msg, inputs);
                worker.terminate();
            } else if (msg.type === 'error') { console.error(msg.message); updateStatus(0, 'Error'); }
        };
        updateStatus(0, 'Calculating');
        worker.postMessage(inputs);
    }

    function renderResults(res, inputs) {
        lastResults = res;
        lastInputs = inputs;

        // --- 1. PROFILE CHART (2D) ---
        if (currentTab === 'profile') {
            const dx = res.dx * 1e6;
            const labels = Array.from({length: inputs.N}, (_, i) => (i * dx).toFixed(2));
            
            const datasets = res.species.map(s => ({
                label: s.fullLabel,
                data: Array.from(s.C).map(v => v * 100),
                borderColor: s.color, backgroundColor: s.color + '20',
                borderWidth: 2, pointRadius: 0, fill: true,
                cubicInterpolationMode: 'monotone', tension: 0.4
            }));
            
            datasets.unshift({
                label: 'MgO Matrix',
                data: Array.from(res.matrix).map(v => v * 100),
                borderColor: '#6366f1', borderWidth: 2, borderDash: [5,5], 
                pointRadius: 0, fill: false, cubicInterpolationMode: 'monotone', tension: 0.4
            });
            
            const interfaceXVal = res.interfaceX * 1e6;
            datasets.push({
                label: 'Orig. Interface',
                borderColor: '#64748b', borderWidth: 2, borderDash: [6, 4], 
                pointRadius: 0, fill: false, showLine: true, type: 'scatter',
                data: [{x: interfaceXVal, y: 0}, {x: interfaceXVal, y: 100}]
            });

            if(chartInstance) chartInstance.destroy();

            chartInstance = new Chart(document.getElementById('diffusionChart'), {
                type: 'line', data: { labels, datasets },
                options: { 
                    responsive: true, maintainAspectRatio: false, animation: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: { 
                        x: { type: 'linear', min: 0, max: inputs.totalLength, title: {display:true, text:'Depth (µm)'} },
                        y: { min: 0, max: 100, title: {display:true, text:'Concentration (%)'} }
                    }
                }
            });

        // --- 2. 3D FLUX CHART (NEW) ---
        } else if (currentTab === 'flux') {
            const xData = Array.from({length: inputs.N}, (_, i) => i * (res.dx * 1e6));
            
            const traces = res.species.map(s => {
                // Use fluxHistory for Z data
                const zData = s.fluxHistory.map(row => Array.from(row));
                const yData = Array.from({length: zData.length}, (_, i) => i * (inputs.timeHours/zData.length));
                return {
                    type: 'surface', 
                    x: xData, y: yData, z: zData,
                    name: s.name, 
                    showscale: false, 
                    showlegend: true,
                    opacity: 0.9,
                    colorscale: [ [0, '#ffffff'], [1, s.color] ]
                };
            });

            Plotly.newPlot('plotly-flux', traces, {
                margin: {l:0,r:0,b:0,t:30}, 
                showlegend: true,
                legend: { x: 0, y: 1 },
                scene: {
                    xaxis:{title:'Depth (µm)'}, 
                    yaxis:{title:'Time (h)'}, 
                    zaxis:{title:'Flux (J)'},
                    camera: { eye: {x: 1.5, y: 1.5, z: 1.5} }
                }
            });

        // --- 3. 3D CONCENTRATION CHART ---
        } else if (currentTab === 'time3d') {
            const xData = Array.from({length: inputs.N}, (_, i) => i * (res.dx * 1e6));
            
            const traces = res.species.map(s => {
                const zData = s.history.map(row => Array.from(row).map(v => v*100));
                const yData = Array.from({length: zData.length}, (_, i) => i * (inputs.timeHours/zData.length));
                return {
                    type: 'surface', 
                    x: xData, y: yData, z: zData,
                    name: s.name, 
                    showscale: false, 
                    showlegend: true,
                    opacity: 0.8,
                    colorscale: [ [0, '#ffffff'], [1, s.color] ]
                };
            });

            Plotly.newPlot('plotly-time', traces, {
                margin: {l:0,r:0,b:0,t:30}, 
                showlegend: true,
                legend: { x: 0, y: 1 },
                scene: {
                    xaxis:{title:'Depth (µm)'}, 
                    yaxis:{title:'Time (h)'}, 
                    zaxis:{title:'Conc (%)'}
                }
            });
        }
    }

    function downloadData() {
        if (!lastResults || !lastInputs) { alert("No data to download."); return; }
        
        let csvContent = "data:text/csv;charset=utf-8,";
        
        // 1. Simulation Parameters
        csvContent += "--- SIMULATION PARAMETERS ---\n";
        csvContent += `Temperature (K),${lastInputs.temp}\n`;
        csvContent += `Time (Hours),${lastInputs.timeHours}\n`;
        csvContent += `Source Length (um),${lastInputs.sourceLength}\n`;
        csvContent += `Total Length (um),${lastInputs.totalLength}\n`;
        csvContent += `Matrix D0 (m2/s),${lastInputs.targetD0}\n`;
        csvContent += `Matrix Q (eV),${lastInputs.targetQ}\n`;
        csvContent += `Grid Points,${lastInputs.N}\n\n`;
        
        // 2. Species Info (Updated to include Omega)
        csvContent += "--- SPECIES INFO ---\n";
        csvContent += "Name,D0,Q,Omega (eV),C_Source (%),C_Matrix (%)\n"; // <--- Header Updated
        
        lastInputs.elements.forEach(el => { 
            // <--- Row Updated to include el.omega
            csvContent += `${el.name},${el.d0},${el.q},${el.omega},${el.cLeft},${el.cRight}\n`; 
        });
        
        csvContent += "\n--- CALCULATION RESULTS ---\n";
        
        // 3. Calculation Data (Remains the same)
        let headerRow = ["Depth (um)", "Matrix Conc (%)"];
        lastResults.species.forEach(s => { 
            headerRow.push(`${s.name} Conc (%)`); 
            headerRow.push(`${s.name} Flux (J)`); 
        });
        csvContent += headerRow.join(",") + "\n";
        
        const N = lastInputs.N;
        const dx_um = lastResults.dx * 1e6;
        
        for (let i = 0; i < N; i++) {
            let row = [];
            row.push((i * dx_um).toFixed(4));
            row.push((lastResults.matrix[i] * 100).toFixed(4));
            lastResults.species.forEach(s => { 
                row.push((s.C[i] * 100).toFixed(4)); 
                row.push((s.Flux[i]).toExponential(4)); 
            });
            csvContent += row.join(",") + "\n";
        }
        
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `onsager_diffusion_v8.4.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }


    function validateInputs() {
        const elements = [];
        document.querySelectorAll('.element-card').forEach(card => {
            const nameSelect = card.querySelector('.el-name');
            elements.push({
                name: nameSelect.options[nameSelect.selectedIndex]?.text.split(' ')[0] || "Unk",
                fullLabel: nameSelect.options[nameSelect.selectedIndex]?.text || "Unknown",
                d0: parseFloat(card.querySelector('.el-d0').value), 
                q: parseFloat(card.querySelector('.el-q').value),
                omega: parseFloat(card.querySelector('.el-omega').value) || 0,
                cLeft: parseFloat(card.querySelector('.el-c-left').value),
                cRight: parseFloat(card.querySelector('.el-c-right').value),
                color: card.querySelector('.el-color').value
            });
        });
        if (elements.length === 0) return null;
        const src = parseFloat(document.getElementById('sourceLength').value);
        const tot = parseFloat(document.getElementById('totalLength').value);
        if(src >= tot) { alert("Source length must be smaller than Total length"); return null; }
        return {
            temp: parseFloat(document.getElementById('temp').value),
            timeHours: parseFloat(document.getElementById('time').value),
            sourceLength: src, totalLength: tot,
            N: parseInt(document.getElementById('gridPoints').value),
            targetD0: parseFloat(document.getElementById('targetD0').value),
            targetQ: parseFloat(document.getElementById('targetQ').value),
            elements
        };
    }

    function debouncedUpdate() { clearTimeout(debounceTimer); debounceTimer = setTimeout(triggerCalculation, 600); }
    function switchTab(tab) {
        currentTab = tab;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-' + tab).classList.add('active');
        document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
        document.getElementById('pane-' + tab).classList.add('active');
        if(tab === 'time3d' || tab === 'flux') window.dispatchEvent(new Event('resize'));
        if(tab !== 'help') triggerCalculation();
    }

    function addElement(initialKey = null) {
        const list = document.getElementById('elementsList');
        if (list.children.length >= 4) { alert("Max 4 dopants"); return; }
        const template = document.getElementById('elementTemplate');
        const clone = template.content.cloneNode(true);
        const card = clone.querySelector('.element-card');
        const color = ['#ef4444', '#10b981', '#f59e0b', '#8b5cf6'][list.children.length % 4];
        card.style.borderLeftColor = color;
        clone.querySelector('.el-color').value = color;
        const select = clone.querySelector('.el-name');
        const keys = Object.keys(CATION_DB);
        keys.forEach(k => { const opt = document.createElement('option'); opt.value = k; opt.text = CATION_DB[k].label; select.appendChild(opt); });
        const selectedKey = initialKey || keys[0]; 
        select.value = selectedKey;
        const data = CATION_DB[selectedKey];
        clone.querySelector('.el-d0').value = data.d0;
        clone.querySelector('.el-q').value = data.q;
        clone.querySelector('.el-c-left').value = 25; 
        clone.querySelector('.el-c-right').value = 0;
        clone.querySelector('.delete-btn').onclick = (e) => { e.target.closest('.element-card').remove(); debouncedUpdate(); };
        list.appendChild(clone);
        if(!initialKey) debouncedUpdate();
    }

    function updateElementParams(select) {
        const data = CATION_DB[select.value];
        const card = select.closest('.element-card');
        card.querySelector('.el-d0').value = data.d0;
        card.querySelector('.el-q').value = data.q;
        debouncedUpdate();
    }

    window.onload = function() { addElement("Ni"); setTimeout(triggerCalculation, 100); };
</script>

</body>
</html>